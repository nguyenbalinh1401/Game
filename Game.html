<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>QuizRoom ‚Äì Ch∆°i quiz theo ph√≤ng</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --bg:#0b1020; --card:#121936; --muted:#7e88c6; --accent:#7aa2ff; --good:#19c37d; --bad:#ff5e5e; }
    *{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:radial-gradient(1000px 600px at 10% 10%, #18214d 0%, #0b1020 60%);color:#fff}
    .wrap{max-width:1100px;margin:0 auto;padding:28px}
    h1{font-size:28px;margin:0 0 8px}
    .sub{color:var(--muted);margin:0 0 24px}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:900px){.grid{grid-template-columns:1.2fr .8fr}}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.08);border-radius:18px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .row{display:flex;gap:12px;align-items:center}
    input, textarea, select{width:100%;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.15);background:#0f1530;color:#fff}
    button{cursor:pointer;border:0;background:var(--accent);color:#081126;padding:12px 16px;border-radius:12px;font-weight:700}
    button.ghost{background:transparent;color:#cfe0ff;border:1px solid rgba(255,255,255,.18)}
    .muted{color:var(--muted)} .pill{background:#0e1533;border:1px solid rgba(255,255,255,.14);padding:6px 10px;border-radius:999px;color:#cfe0ff;font-weight:600;display:inline-flex;gap:8px;align-items:center}
    .list{display:grid;gap:10px}
    .q{background:#0f1738;border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:12px}
    .answers{display:grid;gap:10px;margin-top:10px}
    .ans{background:#0c1330;border:1px solid rgba(255,255,255,.08);padding:12px;border-radius:10px}
    .ans.correct{border-color: rgba(25,195,125,.8); outline:2px solid rgba(25,195,125,.25)}
    .ans.wrong{border-color: rgba(255,94,94,.8); outline:2px solid rgba(255,94,94,.18)}
    .flex{display:flex;gap:10px;align-items:center}
    .space{height:10px}
    .center{text-align:center}
    .score{font-weight:800}
    .footer{margin-top:24px;color:#98a7ff80;font-size:12px}
    .badge{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.18);background:#0b132e;}
    .players{display:flex;flex-wrap:wrap;gap:8px}
    .player{background:#0e1737;border:1px solid rgba(255,255,255,.1);padding:8px 10px;border-radius:999px}
    .danger{background:var(--bad);color:#220b0b}
    .good{background:var(--good);color:#05160f}
    .hr{height:1px;background:rgba(255,255,255,.08);margin:14px 0}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>QuizRoom üéØ</h1>
    <p class="sub">T·∫°o ph√≤ng ‚Äì M·ªùi b·∫°n b√® ‚Äì Ch∆°i quiz theo th·ªùi gian th·ª±c (Firebase). Tri·ªÉn khai d·ªÖ d√†ng tr√™n Vercel.</p>

    <div class="grid">
      <!-- HOST / CONTROL PANEL -->
      <div class="card" id="hostPanel">
        <div class="row" style="justify-content:space-between">
          <strong>B·∫£ng ƒëi·ªÅu khi·ªÉn (Host)</strong>
          <span class="pill">Tr·∫°ng th√°i: <span id="status">Ch∆∞a k·∫øt n·ªëi</span></span>
        </div>
        <div class="hr"></div>
        <div class="row">
          <input id="roomId" placeholder="Nh·∫≠p m√£ ph√≤ng (v√≠ d·ª•: ECO101)" />
          <button id="createRoomBtn">T·∫°o / V√†o ph√≤ng</button>
          <button class="ghost" id="copyLinkBtn">Sao ch√©p link ph√≤ng</button>
        </div>
        <div class="space"></div>

        <div class="row">
          <textarea id="questionText" rows="3" placeholder="Nh·∫≠p c√¢u h·ªèi‚Ä¶"></textarea>
        </div>
        <div class="row">
          <div style="flex:1"><input id="a1" placeholder="ƒê√°p √°n A"/></div>
          <div style="flex:1"><input id="a2" placeholder="ƒê√°p √°n B"/></div>
          <div style="flex:1"><input id="a3" placeholder="ƒê√°p √°n C"/></div>
          <div style="flex:1"><input id="a4" placeholder="ƒê√°p √°n D"/></div>
          <div style="width:160px">
            <select id="correct">
              <option value="0">ƒê√°p √°n ƒë√∫ng: A</option>
              <option value="1">ƒê√°p √°n ƒë√∫ng: B</option>
              <option value="2">ƒê√°p √°n ƒë√∫ng: C</option>
              <option value="3">ƒê√°p √°n ƒë√∫ng: D</option>
            </select>
          </div>
        </div>
        <div class="space"></div>
        <div class="row">
          <button id="pushQuestion">G·ª≠i c√¢u h·ªèi cho ph√≤ng</button>
          <button class="ghost" id="revealBtn">Hi·ªán k·∫øt qu·∫£</button>
          <button class="ghost danger" id="resetAnswers">Xo√° c√¢u tr·∫£ l·ªùi</button>
        </div>

        <div class="hr"></div>
        <div>
          <div class="row"><strong>Ng∆∞·ªùi ch∆°i trong ph√≤ng</strong> <span class="badge" id="playerCount">0</span></div>
          <div class="players" id="players"></div>
        </div>

        <div class="hr"></div>
        <div>
          <div class="row"><strong>B·∫£ng ƒëi·ªÉm</strong></div>
          <div id="scoreboard" class="list"></div>
        </div>
      </div>

      <!-- PLAYER / JOIN PANEL -->
      <div class="card">
        <strong>Tham gia ch∆°i (Player)</strong>
        <div class="hr"></div>
        <div class="row">
          <input id="joinRoom" placeholder="M√£ ph√≤ng" />
          <input id="nickname" placeholder="T√™n c·ªßa b·∫°n" />
          <button id="joinBtn">Tham gia</button>
        </div>
        <div class="space"></div>
        <div id="playerArea" style="display:none">
          <div class="row" style="justify-content:space-between">
            <span class="pill">Ph√≤ng: <span id="roomBadge">-</span></span>
            <span class="pill">B·∫°n: <span id="me">-</span></span>
          </div>
          <div class="hr"></div>
          <div id="liveQuestion" class="q">Ch·ªù host g·ª≠i c√¢u h·ªèi‚Ä¶</div>
          <div class="answers" id="answerBtns" style="display:none"></div>
          <div class="center muted" id="hint"></div>
        </div>
      </div>
    </div>

    <div class="footer">üî• H∆∞·ªõng d·∫´n c·∫•u h√¨nh Firebase n·∫±m cu·ªëi file. M√£ ngu·ªìn: 1 file HTML duy nh·∫•t ‚Äì k√©o th·∫£ l√™n Vercel l√† ch·∫°y.</div>
  </div>

  <!-- Firebase v9 (CDN) -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getDatabase, ref, set, onValue, update, push, get, child, remove } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js';

    // =====================
    // 1) C·∫§U H√åNH FIREBASE
    // =====================
    // TODO: THAY c√°c gi√° tr·ªã d∆∞·ªõi ƒë√¢y b·∫±ng d·ª± √°n Firebase c·ªßa b·∫°n
    const firebaseConfig = {
  apiKey: "AIzaSyDA3fp5A2cGB63kMA8TlEJ2x49rr4DiYbA",
  authDomain: "game-75e2a.firebaseapp.com",
  databaseURL: "https://game-75e2a-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "game-75e2a",
  storageBucket: "game-75e2a.firebasestorage.app",
  messagingSenderId: "763894782961",
  appId: "1:763894782961:web:84465068beb77de8024250",
  measurementId: "G-E10MQ37X5Y"
};

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Helpers
    const $ = (id) => document.getElementById(id);
    const statusEl = $("status");
    const playersEl = $("players");
    const scoreboardEl = $("scoreboard");

    let myPlayerId = null;
    let joinedRoomId = null;

    // =====================
    // 2) HOST: T·∫°o/V√†o ph√≤ng
    // =====================
    $("createRoomBtn").onclick = async () => {
      const roomId = $("roomId").value.trim().toUpperCase();
      if(!roomId) return alert("Nh·∫≠p m√£ ph√≤ng");
      const base = ref(db, `rooms/${roomId}`);
      const now = Date.now();
      // T·∫°o ph√≤ng n·∫øu ch∆∞a c√≥
      await update(base, { createdAt: now });
      statusEl.textContent = `ƒê√£ v√†o ph√≤ng ${roomId}`;
      // L·∫Øng nghe danh s√°ch ng∆∞·ªùi ch∆°i
      onValue(ref(db, `rooms/${roomId}/players`), (snap) => {
        const players = snap.val() || {};
        playersEl.innerHTML = '';
        const ids = Object.keys(players);
        $("playerCount").textContent = ids.length;
        ids.forEach(id => {
          const p = players[id];
          const chip = document.createElement('div');
          chip.className = 'player';
          chip.textContent = `${p.name} ‚Ä¢ ${p.score||0}`;
          playersEl.appendChild(chip);
        })
      });
      // L·∫Øng nghe b·∫£ng ƒëi·ªÉm
      onValue(ref(db, `rooms/${roomId}/scores`), (snap) => {
        const scores = snap.val() || {};
        const arr = Object.values(scores).sort((a,b)=> (b.score||0)-(a.score||0));
        scoreboardEl.innerHTML = '';
        arr.forEach((s, idx) => {
          const item = document.createElement('div');
          item.className='q';
          item.innerHTML = `<div class="row" style="justify-content:space-between"><div><strong>${idx+1}. ${s.name}</strong></div><div class="score">${s.score||0} ƒëi·ªÉm</div></div>`;
          scoreboardEl.appendChild(item);
        })
      });

      // Copy link join
      $("copyLinkBtn").onclick = async () => {
        const url = `${location.origin}${location.pathname}?room=${roomId}`;
        await navigator.clipboard.writeText(url);
        alert("ƒê√£ sao ch√©p link: " + url);
      }

      // G·ª≠i c√¢u h·ªèi t·ªõi ph√≤ng
      $("pushQuestion").onclick = async () => {
        const q = $("questionText").value.trim();
        const a = [$("a1").value, $("a2").value, $("a3").value, $("a4").value].map(x=>x||'');
        const correct = parseInt($("correct").value,10);
        if(!q || a.filter(Boolean).length < 2) return alert("Nh·∫≠p c√¢u h·ªèi v√† t·ªëi thi·ªÉu 2 ƒë√°p √°n");
        await update(ref(db, `rooms/${roomId}/live`), { q, a, correct, reveal:false, ts: Date.now() });
        // Reset l∆∞·ª£t tr·∫£ l·ªùi c≈©
        await remove(ref(db, `rooms/${roomId}/answers`));
      }
      // Hi·ªán k·∫øt qu·∫£
      $("revealBtn").onclick = async () => {
        await update(ref(db, `rooms/${roomId}/live`), { reveal: true });
        // ch·∫•m ƒëi·ªÉm: ai tr·∫£ l·ªùi ƒë√∫ng +10
        const ansSnap = await get(ref(db, `rooms/${roomId}/answers`));
        const answers = ansSnap.val() || {};
        const live = (await get(ref(db, `rooms/${roomId}/live`))).val();
        Object.keys(answers).forEach(async pid => {
          const isCorrect = answers[pid].choice === live.correct;
          const delta = isCorrect ? 10 : 0;
          const p = (await get(ref(db, `rooms/${roomId}/players/${pid}`))).val();
          const newScore = (p?.score||0) + delta;
          await update(ref(db, `rooms/${roomId}/players/${pid}`), { score: newScore });
          await update(ref(db, `rooms/${roomId}/scores/${pid}`), { name:p.name, score:newScore });
        });
      }
      // Xo√° c√¢u tr·∫£ l·ªùi
      $("resetAnswers").onclick = async () => {
        await remove(ref(db, `rooms/${roomId}/answers`));
      }
    };

    // =====================
    // 3) PLAYER: Tham gia & tr·∫£ l·ªùi
    // =====================
    function useQueryParam(name){
      const url = new URL(location.href); return url.searchParams.get(name);
    }
    const roomFromUrl = useQueryParam('room');
    if(roomFromUrl){ $("joinRoom").value = roomFromUrl; }

    $("joinBtn").onclick = async () => {
      const roomId = $("joinRoom").value.trim().toUpperCase();
      const name = $("nickname").value.trim();
      if(!roomId || !name) return alert("Nh·∫≠p m√£ ph√≤ng v√† t√™n");
      joinedRoomId = roomId;
      const base = ref(db, `rooms/${roomId}`);

      // T·∫°o player id d·ª±a theo random + th·ªùi gian
      myPlayerId = 'p_'+Math.random().toString(36).slice(2,8);
      await update(ref(db, `rooms/${roomId}/players/${myPlayerId}`), { name, score:0, joinedAt: Date.now() });
      await update(ref(db, `rooms/${roomId}/scores/${myPlayerId}`), { name, score:0 });

      // UI state
      $("playerArea").style.display='block';
      $("roomBadge").textContent = roomId;
      $("me").textContent = name;

      // L·∫Øng nghe c√¢u h·ªèi tr·ª±c ti·∫øp
      onValue(ref(db, `rooms/${roomId}/live`), (snap) => {
        const live = snap.val();
        const liveQ = $("liveQuestion");
        const ansBox = $("answerBtns");
        const hint = $("hint");
        if(!live){
          liveQ.textContent = 'Ch·ªù host g·ª≠i c√¢u h·ªèi‚Ä¶';
          ansBox.style.display='none';
          hint.textContent = '';
          return;
        }
        liveQ.innerHTML = `<strong>C√¢u h·ªèi:</strong> ${live.q}`;
        ansBox.innerHTML='';
        (live.a||[]).forEach((text, idx)=>{
          const btn = document.createElement('button');
          btn.className='ans';
          btn.textContent = `${String.fromCharCode(65+idx)}. ${text}`;
          btn.onclick = async () => {
            // ch·ªâ cho tr·∫£ l·ªùi 1 l·∫ßn / c√¢u
            const already = await get(ref(db, `rooms/${roomId}/answers/${myPlayerId}`));
            if(already.exists()){ hint.textContent = 'B·∫°n ƒë√£ tr·∫£ l·ªùi. Ch·ªù c√¥ng b·ªë k·∫øt qu·∫£‚Ä¶'; return; }
            await update(ref(db, `rooms/${roomId}/answers/${myPlayerId}`), { choice: idx, at: Date.now(), name });
            hint.textContent = 'ƒê√£ ghi nh·∫≠n c√¢u tr·∫£ l·ªùi!';
          };
          ansBox.appendChild(btn);
        });
        ansBox.style.display='grid';
        hint.textContent = 'Ch·ªçn ƒë√°p √°n c·ªßa b·∫°n.';

        // Khi host b·∫•m hi·ªán k·∫øt qu·∫£ => t√¥ m√†u ƒë√∫ng/sai
        if(live.reveal){
          Array.from(ansBox.children).forEach((el, idx)=>{
            el.classList.remove('correct','wrong');
            if(idx===live.correct) el.classList.add('correct'); else el.classList.add('wrong');
          });
          hint.textContent = 'K·∫øt qu·∫£ ƒë√£ c√¥ng b·ªë!';
        }
      });

      alert(`ƒê√£ tham gia ph√≤ng ${roomId}. H√£y ch·ªù host!`);
    };

    // C·∫£nh b√°o r·ªùi trang
    window.addEventListener('beforeunload', (e)=>{ if(joinedRoomId && myPlayerId){ update(ref(db, `rooms/${joinedRoomId}/players/${myPlayerId}`), { leftAt: Date.now() }); } });
  </script>

  <!--
  ===========================
  H∆Ø·ªöNG D·∫™N TRI·ªÇN KHAI (Firebase + Vercel)
  ===========================
  1) T·∫°o d·ª± √°n Firebase ‚Üí Realtime Database (location: asia-southeast1 c√†ng t·ªët n·∫øu VN)
  2) V√†o "Project settings" ‚Üí "General" ‚Üí "Your apps" ‚Üí Web app ‚Üí copy config v√† d√°n v√†o bi·∫øn firebaseConfig ·ªü tr√™n
  3) Realtime Database ‚Üí Rules (t·∫°m th·ªùi cho l·ªõp h·ªçc) ƒë·∫∑t:
     {
       "rules": {
         ".read": true,
         ".write": true
       }
     }
     (Sau bu·ªïi h·ªçc, h√£y si·∫øt rule ch·ªâ cho ph√©p ghi theo room ho·∫∑c auth.)

  4) Deploy Vercel:
     - T·∫°o repo Git ho·∫∑c k√©o-th·∫£ file index.html n√†y l√™n https://vercel.com/new ‚Üí ch·ªçn "Other" (Static)
     - Sau deploy, URL c√¥ng khai s·∫Ω ·ªü d·∫°ng https://ten-du-an.vercel.app
     - Host b·∫•m "T·∫°o / V√†o ph√≤ng" (v√≠ d·ª•: ECO101) ‚Üí b·∫•m "Sao ch√©p link ph√≤ng" g·ª≠i cho l·ªõp
     - Ng∆∞·ªùi ch∆°i m·ªü link, nh·∫≠p t√™n, tham gia v√† ch∆°i ngay

  M·∫∏O D·∫†Y H·ªåC:
  - C·ªông ƒëi·ªÉm m·ªói c√¢u ƒë√∫ng +10 (ƒëang m·∫∑c ƒë·ªãnh). B·∫°n c√≥ th·ªÉ s·ª≠a trong h√†m revealBtn.
  - Chu·∫©n b·ªã s·∫µn danh s√°ch c√¢u h·ªèi: ch·ªâ c·∫ßn d√°n nhanh v√†o c√°c √¥ v√† b·∫•m G·ª≠i.
  - D√πng m√°y chi·∫øu m·ªü b·∫£ng ƒëi·ªÅu khi·ªÉn (hostPanel); h·ªçc vi√™n d√πng ƒëi·ªán tho·∫°i ƒë·ªÉ tr·∫£ l·ªùi.
  - Sau bu·ªïi, ƒë·ªïi Rules c·ªßa DB v·ªÅ ch·∫ø ƒë·ªô an to√†n ho·∫∑c xo√° d·ªØ li·ªáu rooms/‚Ä¶
  -->
</body>
</html>
